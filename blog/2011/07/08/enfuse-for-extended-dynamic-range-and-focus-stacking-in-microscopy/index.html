
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Enfuse for Extended Dynamic Range and Focus Stacking in Microscopy - Martin Foot</title>
  <meta name="author" content="Martin Foot">

  
  <meta name="description" content="[caption id=&#8221;attachment_146&#8221; align=&#8221;aligncenter&#8221; width=&#8221;656&#8221; caption=&#8221;The right eye and antennae of a bee &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mfoo.github.com/blog/2011/07/08/enfuse-for-extended-dynamic-range-and-focus-stacking-in-microscopy/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Martin Foot" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Martin Foot</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mfoo.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Enfuse for Extended Dynamic Range and Focus Stacking in Microscopy</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-08T04:09:53+01:00" pubdate data-updated="true">Jul 8<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>[caption id=&#8221;attachment_146&#8221; align=&#8221;aligncenter&#8221; width=&#8221;656&#8221; caption=&#8221;The right eye and antennae of a bee produced from a stack of different photographs combined with Enfuse.&#8221;]<a href="http://www.mfoot.com/wp-content/uploads/2011/07/bee_closeup.png"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/bee_closeup.png" alt="Bee Closeup" /></a>[/caption]</p>

<p><a href="http://enblend.sourceforge.net/">Enfuse</a> is a piece of open source software that is designed for combining multiple images containing different exposures of the same scene into a single image that is well-exposed as possible. This process is called exposure fusion, not to be confused with the popular high dynamic range (HDR) techniques. HDR techniques build a single high dynamic range source image and then apply a tone mapping operator to compress it into a range that a monitor can display or a printer can print. <em>Enfuse</em> skips this step and tries to combine pixels from each source image directly into an output image by assigning each pixel a weighting based on contrast, exposure and saturation calculations in the pixel&#8217;s local area. Pixels from each coordinate in the image stack are then combined based on their weightings.</p>

<p>This method of combining pixels means that not only is <em>Enfuse</em> good at combining multiple exposures, but it is good at combining focus stacks &#8212; images that are focussed on different parts of the subject. By weighting the decision heavily on local neighborhood contrast rather than saturation and exposure and telling <em>Enfuse</em> to only use the pixel with the highest weighting from the stack (rather than combining pixels in the stack based on weighting) we can perform focus stacking.</p>

<p>I recently tried <em>Enfuse</em> on images captured directly from a microscope and have shown that it&#8217;s very useful when the subject contains both light and dark (and matte and glossy) areas where it&#8217;s difficult to illuminate correctly with a single lighting setup. The images below show six different exposures of a piece of mould growing on a coffee cup that was in the PhD lab at the time. There&#8217;s a crack in the sample and the light from underneath shines through, making it difficult to see the image detail in that area without underexposing the top.</p>

<p><a href="http://www.mfoot.com/wp-content/uploads/2011/07/1031_small.png"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/1031_small.png" alt="" /></a><a href="http://www.mfoot.com/wp-content/uploads/2011/07/1030_small.png"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/1030_small.png" alt="" /></a><a href="http://www.mfoot.com/wp-content/uploads/2011/07/1029_small.png"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/1029_small.png" alt="" /></a></p>

<p><a href="http://www.mfoot.com/wp-content/uploads/2011/07/1028_small.png"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/1028_small.png" alt="" /></a><a href="http://www.mfoot.com/wp-content/uploads/2011/07/1027_small.png"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/1027_small.png" alt="" /></a><a href="http://www.mfoot.com/wp-content/uploads/2011/07/1026_small.png"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/1026_small.png" alt="" /></a></p>

<p>When these are combined in <em>Enfuse</em> we get an output that looks like the one below with no over- or under-exposed areas.</p>

<p>[caption id=&#8221;attachment_131&#8221; align=&#8221;aligncenter&#8221; width=&#8221;400&#8221; caption=&#8221;Exposure fused composite&#8221;]<a href="http://www.mfoot.com/wp-content/uploads/2011/07/hdr181031_small.jpg"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/hdr181031_small.jpg" alt="Exposure fused composite" /></a>[/caption]</p>

<p>I wrote a Python wrapper for the microscope-mounted camera to capture photos and another Python wrapper for the stage&#8217;s RS-232 instruction set and set up an automated process to take six different exposures at a time and then move the stage in the Z axis and repeat. After combining each of the six images into an exposure-fused output and then combining those images in a focus stack we can produce something like this:</p>

<p>[caption id=&#8221;attachment_132&#8221; align=&#8221;aligncenter&#8221; width=&#8221;400&#8221; caption=&#8221;Output of using Enfuse to focus stack a stack of exposure-fused images. Note that the lines in the image aren&#8217;t produced by Enfuse, there were some problems with the data capture and some parts of the image were lost.&#8221;]<a href="http://www.mfoot.com/wp-content/uploads/2011/07/stacked18.png"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/stacked18.png" alt="Stacked Mould Images" /></a>[/caption]</p>

<p>Now we&#8217;ve shown that focus stacking works nicely on exposure fused images from the microscope, we can expand the program to move the stage around and build up a mosaic as shown below.</p>

<p>[caption id=&#8221;attachment_136&#8221; align=&#8221;aligncenter&#8221; width=&#8221;700&#8221; caption=&#8221;A composite of 9 different exposure fused focus stacks.&#8221;]<a href="http://www.mfoot.com/wp-content/uploads/2011/07/mouldPanoIM.jpg"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/mouldPanoIM.jpg" alt="Mould Mosaic" /></a>[/caption]</p>

<p>With a different subject with a much greater physical depth (more Z-steps) we can produce something that looks like the bee below. This image is a composite of 3600 source images that were automatically combined with <em>Enfuse</em> and then were stitched together into the mosaic manually. The output is something that would never be visible to the human eye due to physical limitations of the lens, and the final composite is around 90 megapixels. The image here is an incredibly reduced version of it. A full resolution version can be found <a href="http://www.mfoot.com/3yp/bee.jpg">here (warning: 10 megabytes jpg file, 7680x11728px, may crash your browser)</a>.</p>

<p>[caption id=&#8221;attachment_145&#8221; align=&#8221;aligncenter&#8221; width=&#8221;397&#8221; caption=&#8221;A composite of 3600 images fused with Enfuse and manually stitched.&#8221;]<a href="http://www.mfoot.com/wp-content/uploads/2011/07/bee1.png"><img src="http://www.mfoot.com/wp-content/uploads/2011/07/bee1.png" alt="Bee Mosaic" /></a>[/caption]</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Martin Foot</span></span>

      








  


<time datetime="2011-07-08T04:09:53+01:00" pubdate data-updated="true">Jul 8<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/photography/'>Photography</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mfoo.github.com/blog/2011/07/08/enfuse-for-extended-dynamic-range-and-focus-stacking-in-microscopy/" data-via="martinfoot" data-counturl="http://mfoo.github.com/blog/2011/07/08/enfuse-for-extended-dynamic-range-and-focus-stacking-in-microscopy/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2010/09/23/game-development-rss-feeds/" title="Previous Post: Game Development RSS Feeds">&laquo; Game Development RSS Feeds</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/07/08/automatically-download-national-geographics-photo-of-the-day-and-set-it-as-your-desktop-background/" title="Next Post: Automatically download National Geographic's Photo of the Day and set it as your desktop background">Automatically download National Geographic's Photo of the Day and set it as your desktop background &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/01/introduction-to-genetics-and-evolution/">Introduction to Genetics and Evolution</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/01/vim-precision-editing-at-the-speed-of-thought/">Vim - precision editing at the speed of thought</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/26/custom-rake-tasks-for-dbdrop-dbcreate-dbmigrate-dbseed/">Custom Rake Tasks for db:drop db:create db:migrate db:seed</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/26/a-simple-lindenmayer-system-renderer/">A Simple Lindenmayer System Renderer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/22/conways-game-of-life-in-coffeescript/">Conway's Game of Life in CoffeeScript</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mfoo">@mfoo</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mfoo',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("martinfoot", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/martinfoot" class="twitter-follow-button" data-show-count="false">Follow @martinfoot</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Martin Foot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
