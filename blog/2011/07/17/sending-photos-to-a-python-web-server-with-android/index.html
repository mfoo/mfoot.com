
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Sending photos to a Python web server with Android - Martin Foot</title>
  <meta name="author" content="Martin Foot">

  
  <meta name="description" content="I recently involved in a project where we performed some computer vision object recognition and classification using neural networks and SVMs. It was &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mfoo.github.com/blog/2011/07/17/sending-photos-to-a-python-web-server-with-android/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Martin Foot" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Martin Foot</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mfoo.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Sending Photos to a Python Web Server With Android</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-17T10:22:08+01:00" pubdate data-updated="true">Jul 17<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I recently involved in a project where we performed some computer vision object recognition and classification using neural networks and SVMs. It was necessary to use photos taken from an Android phone and it took a little while to get it working. Below is the solution I used, which involved creating a tiny Android application that took a photo, Base64 encoded it, then sent the data over HTTP POST to a Python BaseHTTPRequestHandler subclass which decoded the file and wrote it to disk.</p>

<p>The solution uses a slightly modified version of <a href="http://coderzheaven.com/2011/04/25/android-upload-an-image-to-a-server/">this example for Android</a> that uses <a href="http://iharder.sourceforge.net/current/java/base64/">this Java Base64 encode/decode class</a>. The Python script is based on <a href="http://fragments.turtlemeat.com/pythonwebserver.php">an example by Jon Berg</a>.</p>

<p>The Python web server is below:</p>

<p>[sourcecode language=&#8221;python&#8221;]</p>

<h1>!/usr/bin/env python</h1>

<p>import cgi
from BaseHTTPServer import BaseHTTPRequestHandler, HTTPServer</p>

<p>class MyHandler(BaseHTTPRequestHandler):</p>

<pre><code>def do_GET(self):
    print "Somebody made a POST request."
    return

def do_POST(self):
    """
    Take the Base64 encoded string that the phone transmit, decode it and
    save it as an image file called phone.jpg.
    """
    global rootnode
    try:
        ctype, pdict = cgi.parse_header(self.headers.getheader('content-type'))
        print ctype
        print pdict
        if ctype == 'multipart/form-data':
            query=cgi.parse_multipart(self.rfile, pdict)
        elif ctype == 'application/x-www-form-urlencoded':
            length = int(self.headers.getheader('content-length'))
            query = cgi.parse_qs(self.rfile.read(length), keep_blank_values=1)

        self.send_response(301)
        self.send_header('Content-type', 'text/html')
        self.end_headers()

        upfilecontent = query.get('upfile')
        self.wfile.write("POST OK.
</code></pre>

<p>&#8221;);</p>

<pre><code>        f = open("phone.jpg", "wb")
        f.write(upfilecontent[0].decode('base64'))
        f.close()
        print("File received.")

        return
    except Exception, err:
        print Exception, err
        pass
</code></pre>

<p>def main():</p>

<pre><code>try:
    server = HTTPServer(('', 8000), MyHandler)
    print 'started httpserver...'
    server.serve_forever()
except KeyboardInterrupt:
    print '^C received, shutting down server'
    server.socket.close()
</code></pre>

<p>if <strong>name</strong> == &#8217;<strong>main</strong>&#8217;:</p>

<pre><code>main()
</code></pre>

<p>[/sourcecode]</p>

<p>And here&#8217;s the Android Activity (remember to add the <a href="http://developer.android.com/reference/android/Manifest.permission.html#CAMERA">CAMERA permission</a> to your manifest and add the above linked Base64 encoding class to your workspace and package).</p>

<p>[sourcecode language=&#8221;java&#8221;]
package com.elec6024.eardetection;</p>

<p>/<em>*
 * This Android Activity takes a photo and uploads it to a server.
 * The server upload HTTP POST code is modified from this:
 * http://coderzheaven.com/index.php/2011/04/android-upload-an-image-to-a-server/
 </em>/
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;</p>

<p>import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.HttpClient;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.message.BasicNameValuePair;</p>

<p>import android.app.Activity;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.provider.MediaStore;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.Toast;</p>

<p>public class MainActivity extends Activity
{</p>

<pre><code>private Uri outputFileUri;
private InputStream inputStream;
public static final int PICTURE_ACTIVITY = 35434;

/* Override the onCreate method */
@Override
public void onCreate(Bundle savedInstanceState)
{
    super.onCreate(savedInstanceState);

    setContentView(R.layout.main);
    final Button cameraButton = (Button)findViewById(R.id.camera_button);
    cameraButton.setOnClickListener(new OnClickListener() {
        @Override
        public void onClick(View v){
            // Check if there's external storage available and that it's writeable.
            boolean mExternalStorageAvailable = false;
            boolean mExternalStorageWriteable = false;
            String state = Environment.getExternalStorageState();

            if (Environment.MEDIA_MOUNTED.equals(state)) {
                // We can read and write the media
                mExternalStorageAvailable = mExternalStorageWriteable = true;
            } else if (Environment.MEDIA_MOUNTED_READ_ONLY.equals(state)) {
                // We can only read the media
                mExternalStorageAvailable = true;
                mExternalStorageWriteable = false;
            } else {
                // Something else is wrong. It may be one of many other states, but all we need
                //  to know is we can neither read nor write
                mExternalStorageAvailable = mExternalStorageWriteable = false;
            }

            if(mExternalStorageAvailable &amp;&amp; mExternalStorageWriteable){
                Intent cameraIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); // Normally you would populate this with your custom intent.
                File file = new File(Environment.getExternalStorageDirectory(),"imagefile.jpg");
                outputFileUri = Uri.fromFile(file);
                cameraIntent.putExtra(MediaStore.EXTRA_OUTPUT, outputFileUri);
                startActivityForResult(cameraIntent, PICTURE_ACTIVITY);
            }
        }
    });
}

@Override
protected void onActivityResult(int requestCode, int resultCode, Intent intent) {
    super.onActivityResult(requestCode, resultCode, intent);

    if (requestCode == PICTURE_ACTIVITY &amp;&amp; resultCode == Activity.RESULT_OK) {

        File file = new File(Environment.getExternalStorageDirectory(),"imagefile.jpg");
        if(file.exists()){
            ByteArrayOutputStream stream = new ByteArrayOutputStream();

            // Enclose this in a scope so that when it's over we can call the garbage collector (the phone doesn't have a lot of memory!)
            {
                Bitmap image = BitmapFactory.decodeFile(file.getPath());
                Bitmap scaled = Bitmap.createScaledBitmap(image, (int)(image.getWidth() * 0.3), (int)(image.getHeight() * 0.3), false);
                scaled.compress(Bitmap.CompressFormat.JPEG, 90, stream);
            }

            System.gc();

            byte [] byte_arr = stream.toByteArray();
            String image_str = Base64.encodeBytes(byte_arr);
            ArrayList nameValuePairs = new ArrayList();

            nameValuePairs.add(new BasicNameValuePair("upfile",image_str));

            try {
                HttpClient httpclient = new DefaultHttpClient();
                final String URL = "http://192.168.2.3:8000";
                HttpPost httppost = new HttpPost(URL);
                httppost.setEntity(new UrlEncodedFormEntity(nameValuePairs));
                HttpResponse response = httpclient.execute(httppost);
                String the_string_response = convertResponseToString(response);
                Toast.makeText(MainActivity.this, "Response " + the_string_response, Toast.LENGTH_LONG).show();
            } catch(Exception e){
                  Toast.makeText(MainActivity
                          .this, "ERROR " + e.getMessage(), Toast.LENGTH_LONG).show();
                  System.out.println("Error in http connection "+e.toString());
                  e.printStackTrace();
            }
        }
    }
}

public String convertResponseToString(HttpResponse response) throws IllegalStateException, IOException{
    String res = "";
    StringBuffer buffer = new StringBuffer();
    inputStream = response.getEntity().getContent();
    int contentLength = (int) response.getEntity().getContentLength(); //getting content length…..
        Toast.makeText(MainActivity.this, "contentLength : " + contentLength, Toast.LENGTH_LONG).show();
    if (contentLength &lt; 0){         }         else{                byte[] data = new byte[512];                int len = 0;                try                {                    while (-1 != (len = inputStream.read(data)) )                    {                        buffer.append(new String(data, 0, len)); //converting to string and appending  to stringbuffer…..                    }                }                catch (IOException e)                {                    e.printStackTrace();                }                try                {                    inputStream.close(); // closing the stream…..                }                catch (IOException e)                {                    e.printStackTrace();                }                res = buffer.toString();     // converting stringbuffer to string…..                Toast.makeText(MainActivity.this, "Result : " + res, Toast.LENGTH_LONG).show();                //System.out.println("Response =&gt; " +  EntityUtils.toString(response.getEntity()));
    }
    return res;
</code></pre>

<p>   }
}</p>

<p>[/sourcecode]</p>

<p>You&#8217;ll also need the layout file for the application:</p>

<p>[sourcecode language=&#8221;xml&#8221;]
&lt;?xml version=&#8221;1.0&#8221; encoding=&#8221;utf-8&#8221;?>
&lt;LinearLayout xmlns:android=&#8221;http://schemas.android.com/apk/res/android&#8221;</p>

<pre><code>android:orientation="vertical"
android:layout_width="fill_parent"
android:layout_height="fill_parent"
&gt;
&lt;ImageView android:layout_weight="2" 
    android:id="@+id/imageview"
    android:layout_width="fill_parent"
    android:layout_height="fill_parent" /&gt;
&lt;Button
android:id="@+id/camera_button"
android:layout_weight="1"
android:layout_width="fill_parent"
android:layout_height="wrap_content"
android:text="@string/camera_button_text" 
android:textSize="@dimen/big_text"/&gt;
</code></pre>

<p></LinearLayout></p>

<p>[/sourcecode]</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Martin Foot</span></span>

      








  


<time datetime="2011-07-17T10:22:08+01:00" pubdate data-updated="true">Jul 17<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>Android</a>, <a class='category' href='/blog/categories/programming/'>Programming</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mfoo.github.com/blog/2011/07/17/sending-photos-to-a-python-web-server-with-android/" data-via="martinfoot" data-counturl="http://mfoo.github.com/blog/2011/07/17/sending-photos-to-a-python-web-server-with-android/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/07/10/using-doxygen-and-google-c-testing-framework-with-cmake/" title="Previous Post: Using Doxygen and Google C++ Testing Framework with CMake">&laquo; Using Doxygen and Google C++ Testing Framework with CMake</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/09/04/using-compressed-assets-in-librocket-via-physicsfs/" title="Next Post: Using compressed assets in LibRocket via PhysicsFS">Using compressed assets in LibRocket via PhysicsFS &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/01/introduction-to-genetics-and-evolution/">Introduction to Genetics and Evolution</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/01/vim-precision-editing-at-the-speed-of-thought/">Vim - precision editing at the speed of thought</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/26/custom-rake-tasks-for-dbdrop-dbcreate-dbmigrate-dbseed/">Custom Rake Tasks for db:drop db:create db:migrate db:seed</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/26/a-simple-lindenmayer-system-renderer/">A Simple Lindenmayer System Renderer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/22/conways-game-of-life-in-coffeescript/">Conway's Game of Life in CoffeeScript</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mfoo">@mfoo</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mfoo',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("martinfoot", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/martinfoot" class="twitter-follow-button" data-show-count="false">Follow @martinfoot</a>
  
</section>


<section>
  <h1>Stack Overflow</h1>
  <a href="http://stackoverflow.com/users/825879/martinfoot"><img src="http://stackoverflow.com/users/flair/825879.png" width="208" height="58" alt="profile for martinfoot at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for martinfoot at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
</a>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Martin Foot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
